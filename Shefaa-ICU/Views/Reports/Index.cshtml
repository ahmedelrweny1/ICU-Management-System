@{
    ViewData["Title"] = "Reports & Analytics";
    ViewData["PageTitle"] = "Reports & Analytics";
    ViewData["ActivePage"] = "Reports";
    ViewData["HideSearch"] = true;
}

<div class="page-header" data-animate>
    <div>
        <p class="page-eyebrow">Analytics</p>
        <h2>Reports & Analytics</h2>
        <p class="page-subtitle">Review ICU performance indicators and export ready-to-share packs for leadership.</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-soft btn-icon" type="button" onclick="exportHTML()">
            <i class="fas fa-file-code"></i>
            Export HTML
        </button>
        <button class="btn btn-primary btn-icon" type="button" onclick="exportCSV()">
            <i class="fas fa-file-csv"></i>
            Export CSV
        </button>
    </div>
</div>

<div class="card mb-4 delay-1" data-animate>
    <div class="card-header">
        <h5><i class="fas fa-filter"></i> Filters & Search</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 mb-3">
            <div class="col-md-12">
                <label class="form-label">Search</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="reportSearch" placeholder="Search by patient name, condition, or ID...">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <select class="form-select" id="dateRange">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Report Type</label>
                <select class="form-select" id="reportType">
                    <option value="patient">Patient Demographics</option>
                    <option value="room">Room Occupancy</option>
                    <option value="staff">Staff Performance</option>
                    <option value="comprehensive" selected>Comprehensive</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDate">
            </div>
            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDate">
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 delay-2" data-animate>
    <div class="card-header">
        <h5><i class="fas fa-users"></i> Patient Demographics</h5>
        <small>Report for: <span id="reportPeriod">Selected Range</span></small>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="totalAdmissions">0</h4>
                    <p>Total Admissions</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="avgLengthStay">0 Days</h4>
                    <p>Average Length of Stay</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="ageRange">-</h4>
                    <p>Age Range</p>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <h6>Admissions per Day</h6>
                <canvas id="admissionsChart"></canvas>
                @* Data: dataset from admissions history *@
            </div>
            <div class="col-lg-4">
                <h6>Patient Age Groups</h6>
                <canvas id="ageGroupChart"></canvas>
                @* Data: distribution from patient demographics *@
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 delay-3" data-animate>
    <div class="card-header">
        <h5>Patient Details</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Condition</th>
                        <th>Admission Date</th>
                    </tr>
                </thead>
                <tbody id="patientReportTable">
                    @* Data: patient list filtered by range *@
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mb-4 delay-1" data-animate>
    <div class="card-header">
        <h5><i class="fas fa-bed"></i> Room Occupancy</h5>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="occupancyRate">0%</h4>
                    <p>Average Occupancy Rate</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="totalBeds">0</h4>
                    <p>Total ICU Beds</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="avgTurnover">0 Days</h4>
                    <p>Average Turnover Time</p>
                </div>
            </div>
        </div>

        <canvas id="occupancyTrendChart"></canvas>
        @* Data: occupancy trend from Rooms history *@
    </div>
</div>

<div class="card mb-4 delay-2" data-animate>
    <div class="card-header">
        <h5><i class="fas fa-user-md"></i> Staff Performance</h5>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="avgAttendance">0%</h4>
                    <p>Average Attendance Rate</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="totalShifts">0</h4>
                    <p>Total Shifts Covered</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-stat">
                    <h4 id="staffUtilization">0%</h4>
                    <p>Staff Utilization Rate</p>
                </div>
            </div>
        </div>

        <canvas id="staffAttendanceChart"></canvas>
        @* Data: attendance metrics per staff *@
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Pass data from server to JavaScript
        window.reportsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
            patients = ((List<Patient>)ViewBag.Patients ?? new List<Patient>()).Select(p => new {
                id = p.ID,
                name = p.Name,
                age = p.Age ?? 0,
                condition = p.Condition ?? "Unknown",
                admissionDate = p.AdmissionDate.ToString("yyyy-MM-dd")
            }),
            rooms = ((List<Room>)ViewBag.Rooms ?? new List<Room>()).Select(r => new {
                id = r.ID,
                status = r.Status.ToString()
            }),
            staff = ((List<Staff>)ViewBag.Staff ?? new List<Staff>()).Select(s => new {
                id = s.ID,
                name = s.Name,
                role = s.Role
            }),
            totalAdmissions = ViewBag.TotalAdmissions ?? 0,
            minAge = ViewBag.MinAge ?? 0,
            maxAge = ViewBag.MaxAge ?? 0,
            avgStay = ViewBag.AvgStay ?? 0,
            occupancyRate = ViewBag.OccupancyRate ?? 0,
            totalBeds = ViewBag.TotalBeds ?? 0,
            totalShifts = ViewBag.TotalShifts ?? 0,
            staffUtilization = ViewBag.StaffUtilization ?? 0
        }));
    </script>
    <script src="~/js/reports.js" asp-append-version="true"></script>
}

