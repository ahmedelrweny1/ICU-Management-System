@using Shefaa_ICU.Models
@{
    ViewData["Title"] = "Patient Management";
    ViewData["PageTitle"] = "Patient Management";
    ViewData["ActivePage"] = "Patients";
    ViewData["SearchInputId"] = "patientSearch";
    ViewData["SearchPlaceholder"] = "Search patients...";
}

<div class="page-header" data-animate>
    <div>
        <p class="page-eyebrow">Patients</p>
        <h2>Patient Management</h2>
        <p class="page-subtitle">Track admissions, assignments, and clinical progress while keeping critical information one click away.</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-soft btn-icon" type="button" onclick="exportCSV()">
            <i class="fas fa-file-export"></i>
            Export CSV
        </button>
        <button class="btn btn-primary btn-icon" type="button" data-bs-toggle="modal" data-bs-target="#addPatientModal">
            <i class="fas fa-plus"></i>
            Add New Patient
        </button>
    </div>
</div>

<div class="row g-3 filter-card-grid delay-1" data-animate>
    <div class="col-xxl-2 col-md-3 col-sm-6">
        <button type="button" class="filter-card filter-btn active" onclick="filterPatients('all', event)">
            <div class="filter-card-body">
                <span>All Patients</span>
                <small>Overview</small>
            </div>
            <span class="filter-card-count" id="allCount">@((ViewBag.Patients as IEnumerable<dynamic>)?.Count() ?? 0)</span>
        </button>
    </div>
    <div class="col-xxl-2 col-md-3 col-sm-6">
        <button type="button" class="filter-card filter-btn variant-danger" onclick="filterPatients('Critical', event)">
            <div class="filter-card-body">
                <span>Critical</span>
                <small>Needs attention</small>
            </div>
            <span class="filter-card-count" id="criticalCount">@((ViewBag.Patients as IEnumerable<dynamic>)?.Count(p => p.Condition?.ToString().Equals("Critical", StringComparison.OrdinalIgnoreCase) == true) ?? 0)</span>
        </button>
    </div>
    <div class="col-xxl-2 col-md-3 col-sm-6">
        <button type="button" class="filter-card filter-btn variant-success" onclick="filterPatients('Stable', event)">
            <div class="filter-card-body">
                <span>Stable</span>
                <small>Tracking well</small>
            </div>
            <span class="filter-card-count" id="stableCount">@((ViewBag.Patients as IEnumerable<dynamic>)?.Count(p => p.Condition?.ToString().Equals("Stable", StringComparison.OrdinalIgnoreCase) == true) ?? 0)</span>
        </button>
    </div>
    <div class="col-xxl-2 col-md-3 col-sm-6">
        <button type="button" class="filter-card filter-btn variant-warning" onclick="filterPatients('Moderate', event)">
            <div class="filter-card-body">
                <span>Moderate</span>
                <small>Under observation</small>
            </div>
            <span class="filter-card-count" id="moderateCount">@((ViewBag.Patients as IEnumerable<dynamic>)?.Count(p => p.Condition?.ToString().Equals("Moderate", StringComparison.OrdinalIgnoreCase) == true) ?? 0)</span>
        </button>
    </div>
</div>

<div class="card delay-2" data-animate>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th scope="col">Patient</th>
                        <th scope="col">Patient ID</th>
                        <th scope="col">Status</th>
                        <th scope="col">Room</th>
                        <th scope="col">Admission Date</th>
                        <th scope="col">Days in ICU</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody">
                    @if (ViewBag.Patients != null)
                    {
                        foreach (var patient in ViewBag.Patients)
                        {
                            var badgeClass = patient.Condition?.ToLower() switch
                            {
                                "critical" => "bg-danger",
                                "moderate" => "bg-warning",
                                "stable" => "bg-success",
                                _ => "bg-secondary"
                            };
                            var daysInICU = (DateTime.Now - patient.AdmissionDate).Days;

                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="https://ui-avatars.com/api/?name=@patient.Name&background=random&size=40"
                                     alt="@patient.Name" class="rounded-circle me-2">
                                <div>
                                    <strong>@patient.Name</strong>
                                    <div class="text-muted small">@patient.Age years, @(patient.Gender?.ToString() ?? "N/A")</div>
                                </div>
                            </div>
                        </td>
                        <td>@patient.Code</td>
                        <td>
                            <span class="badge @badgeClass">@patient.Condition</span>
                        </td>
                        <td>@patient.RoomNumber</td>
                        <td>@patient.AdmissionDate.ToString("MMM dd, yyyy")</td>
                        <td>@daysInICU days</td>
                        <td>
                            <div class="btn-group">
                                <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Details", "Patients", new { id = patient.ID })">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Edit", "Patients", new { id = patient.ID })">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="post" action="@Url.Action("Delete", "Patients", new { id = patient.ID })" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this patient?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                        }
                    }
                    else
                    {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <br>
                            No patients found
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Modals {
    <div class="modal fade" id="addPatientModal" tabindex="-1" aria-labelledby="patientModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalTitle">Add New Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="@Url.Action("Add", "Patients")">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="Name">Full Name *</label>
                                <input type="text" class="form-control" id="Name" name="Name" required />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label" for="Age">Age *</label>
                                <input type="number" class="form-control" id="Age" name="Age" min="0" max="120" required />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label" for="Gender">Gender *</label>
                                <select class="form-select" id="Gender" name="Gender" required>
                                    <option value="">Select</option>
                                    <option value="0">Male</option>
                                    <option value="1">Female</option>
                                    <option value="2">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="RoomId">Room</label>
                                <select class="form-select" id="RoomId" name="RoomId">
                                    <option value="">Select Room</option>
                                    @if (ViewBag.PatientRooms != null)
                                    {
                                        foreach (var room in ViewBag.PatientRooms)
                                        {
                                            <option value="@room.ID">@room.Number</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="Condition">Condition *</label>
                                <select class="form-select" id="Condition" name="Condition" required>
                                    <option value="">Select Condition</option>
                                    <option value="Stable">Stable</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="AdmissionDate">Admission Date</label>
                                <input type="date" class="form-control" id="AdmissionDate" name="AdmissionDate" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="EmergencyContact">Emergency Contact</label>
                                <input type="text" class="form-control" id="EmergencyContact" name="EmergencyContact" placeholder="Name - Phone Number" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="Complaint">Chief Complaint</label>
                            <textarea class="form-control" id="Complaint" name="Complaint" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="MedicalHistory">Medical History</label>
                            <textarea class="form-control" id="MedicalHistory" name="MedicalHistory" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="Diagnosis">Diagnosis</label>
                            <textarea class="form-control" id="Diagnosis" name="Diagnosis" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="Treatment">Treatment Plan</label>
                            <textarea class="form-control" id="Treatment" name="Treatment" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Patient
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/patients.js" asp-append-version="true"></script>
}
