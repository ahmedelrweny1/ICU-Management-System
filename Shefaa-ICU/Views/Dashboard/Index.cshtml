@model Shefaa_ICU.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    ViewData["PageTitle"] = "Dashboard";
    ViewData["ActivePage"] = "Dashboard";
    ViewData["HideSearch"] = true;
}

<div class="page-header" data-animate>
    <div>
        <p class="page-eyebrow">Operations Center</p>
        <h2>Dashboard Overview</h2>
        <p class="page-subtitle">Real-time pulse of rooms, patients, and staff readiness across Shefaa ICU.</p>
    </div>
    <div class="page-actions">
        <a class="btn btn-soft btn-icon" asp-controller="Reports" asp-action="Index">
            <i class="fas fa-chart-bar"></i>
            View Reports
        </a>
    </div>
</div>

<div class="row g-3 stats-grid" data-animate style="margin-bottom : 45px">
    <div class="col-xxl-2 col-lg-4 col-sm-6">
        <div class="stat-card bg-primary h-100">
            <div class="stat-icon">
                <i class="fas fa-bed"></i>
            </div>
            <div class="stat-details">
                <h3 id="totalRooms">@Model.TotalRooms</h3>
                <p>Total Rooms</p>
            </div>
        </div>
    </div>

    <div class="col-xxl-2 col-lg-4 col-sm-6">
        <div class="stat-card bg-success h-100">
            <div class="stat-icon">
                <i class="fas fa-user-injured"></i>
            </div>
            <div class="stat-details">
                <h3 id="totalPatients">@Model.TotalPatients</h3>
                <p>Current Patients</p>
            </div>
        </div>
    </div>

    <div class="col-xxl-2 col-lg-4 col-sm-6">
        <div class="stat-card bg-info h-100">
            <div class="stat-icon">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="stat-details">
                <h3 id="totalStaff">@Model.TotalStaff</h3>
                <p>Total Staff</p>
            </div>
        </div>
    </div>

    <div class="col-xxl-2 col-lg-4 col-sm-6">
        <div class="stat-card bg-danger h-100">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-details">
                <h3 id="criticalCases">@Model.CriticalCases</h3>
                <p>Critical Cases</p>
            </div>
        </div>
    </div>

    <div class="col-xxl-2 col-lg-4 col-sm-6">
        <div class="stat-card bg-warning h-100">
            <div class="stat-icon">
                <i class="fas fa-door-open"></i>
            </div>
            <div class="stat-details">
                <h3 id="availableRooms">@Model.AvailableRooms</h3>
                <p>Available Rooms</p>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 delay-1" data-animate style="margin-bottom:45px">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Weekly Occupancy</h5>
            </div>
            <div class="card-body">
                <canvas id="occupancyChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bed me-2"></i>Room Status</h5>
            </div>
            <div class="card-body">
                <canvas id="roomStatusChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 delay-2" data-animate style="margin-bottom:45px">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activities</h5>
                <div class="activity-pagination-controls">
                    <button class="btn btn-sm btn-outline-secondary" id="prevActivities" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="mx-2" id="activityPageInfo">Page 1</span>
                    <button class="btn btn-sm btn-outline-secondary" id="nextActivities">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="activityFeed">
                    @if (Model.RecentActivities != null && Model.RecentActivities.Any())
                    {
                        var allActivities = Model.RecentActivities.ToList();
                        
                        @foreach (var activity in allActivities)
                        {
                            var icon = activity.Type?.ToLower() switch
                            {
                                "patient" => "fa-user",
                                "medication" => "fa-pills",
                                "staff" => "fa-user-md",
                                _ => "fa-circle"
                            };
                            <div class="activity-item" style="opacity: 1; display: none;">
                                <div class="activity-icon">
                                    <i class="fas @icon"></i>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text">@activity.Text</p>
                                    <span class="activity-time">@activity.Time</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center py-3">No recent activities</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-md me-2"></i>Staff On Duty</h5>
            </div>
            <div class="card-body">
                <div id="staffOnDuty">
                    @if (Model.StaffOnDutyList != null && Model.StaffOnDutyList.Any())
                    {
                        @foreach (var member in Model.StaffOnDutyList)
                        {
                            var photo = member.ProfilePhotoPath ?? $"https://ui-avatars.com/api/?name={member.Name}&background=6366F1&color=fff&size=40";
                            <div class="staff-item" style="opacity: 1;">
                                <img src="@photo" alt="@member.Name" class="staff-avatar">
                                <div class="staff-info">
                                    <strong>@member.Name</strong>
                                    <small>@member.Role</small>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center py-3">No staff currently on duty</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 delay-3" data-animate style="margin-bottom:45px">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Vitals Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="vitalsChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Vital Alerts</h5>
                <span class="badge bg-danger">@(Model.VitalAlerts?.Count ?? 0)</span>
            </div>
            <div class="card-body">
                <div id="vitalAlerts">
                    @if (Model.VitalAlerts != null && Model.VitalAlerts.Any())
                    {
                        @foreach (var alert in Model.VitalAlerts)
                        {
                            var severityClass = alert.Severity?.ToLower() == "danger" ? "bg-danger" : "bg-warning";
                            <div class="alert-item">
                                <div class="alert-icon @severityClass">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="alert-content">
                                    <strong>@alert.PatientName</strong>
                                    <p>@alert.Metric: @alert.Value</p>
                                    <small>@alert.RecordedAt</small>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center py-3">No vital alerts</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 delay-4" data-animate style="margin-bottom:45px">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Current Shift</h5>
            </div>
            <div class="card-body">
                <div id="currentShift">
                    @if (Model.CurrentShift != null)
                    {
                        <div class="shift-info">
                            <h5>@Model.CurrentShift.ShiftName</h5>
                            <p>@Model.CurrentShift.ShiftTime</p>
                            <span class="badge bg-primary">@Model.CurrentShift.StaffCount Staff</span>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No shift information available</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Pass dashboard data to JavaScript for charts only
        window.dashboardData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model, new System.Text.Json.JsonSerializerOptions { 
            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase 
        }));
        
        // Activity pagination - 5 records per page
        (function() {
            const itemsPerPage = 5;
            let currentPage = 1;
            
            function initPagination() {
                const allActivities = document.querySelectorAll('#activityFeed .activity-item');
                const prevBtn = document.getElementById('prevActivities');
                const nextBtn = document.getElementById('nextActivities');
                const pageInfo = document.getElementById('activityPageInfo');
                const paginationControls = document.querySelector('.activity-pagination-controls');
                
                if (!allActivities || allActivities.length === 0) {
                    if (paginationControls) paginationControls.style.display = 'none';
                    return;
                }
                
                const totalPages = Math.ceil(allActivities.length / itemsPerPage);
                
                function updatePagination() {
                    // Hide all activities first
                    Array.from(allActivities).forEach(item => {
                        item.style.display = 'none';
                    });
                    
                    // Show only 5 activities for current page
                    const start = (currentPage - 1) * itemsPerPage;
                    const end = Math.min(start + itemsPerPage, allActivities.length);
                    
                    for (let i = start; i < end; i++) {
                        if (allActivities[i]) {
                            allActivities[i].style.display = 'flex';
                        }
                    }
                    
                    // Update buttons
                    if (prevBtn) prevBtn.disabled = currentPage === 1;
                    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
                    
                    // Update page info
                    if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (currentPage > 1) {
                            currentPage--;
                            updatePagination();
                        }
                    });
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (currentPage < totalPages) {
                            currentPage++;
                            updatePagination();
                        }
                    });
                }
                
                // Always initialize pagination (even if only 1 page)
                updatePagination();
                
                // Hide pagination controls if only 1 page or less
                if (totalPages <= 1) {
                    if (paginationControls) paginationControls.style.display = 'none';
                }
            }
            
            // Initialize immediately and also on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPagination);
            } else {
                initPagination();
            }
            
            // Also try after a short delay to ensure everything is loaded
            setTimeout(initPagination, 200);
        })();
    </script>
    <script src="~/js/dashboard.js" asp-append-version="true"></script>
}
